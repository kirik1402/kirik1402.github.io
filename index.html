<!DOCTYPE html>
<html>
<head>
    <title>Карта с KML-треками и изображениями на Leaflet и 2ГИС</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="input-container">
        <label for="fileInput" class="button">Import KML</label>
        <input type="file" id="fileInput" accept=".kml" multiple />
    </div>
    <div class="input-container">
        <label for="imageInput" class="button">Import Images</label>
        <input type="file" id="imageInput" accept="image/*" multiple />
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
        // Инициализация карты
        var map = L.map('map').setView([55.751244, 37.618423], 10); // Установите начальные координаты и масштаб (например, Москва)

        // Добавление базового слоя карты (2ГИС)
        L.tileLayer('https://tile0.maps.2gis.com/tiles?x={x}&y={y}&z={z}', {
            maxZoom: 18,
            attribution: '&copy; 2ГИС'
        }).addTo(map);

        // Иконки для первой и последней точки
        var startIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', // URL зеленой иконки
            iconSize: [25, 41], // размер иконки
            iconAnchor: [12, 41], // точка привязки иконки (координата ее "хвоста")
            popupAnchor: [1, -34], // точка, относительно которой будет открываться popup
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });
        
        var endIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', // URL красной иконки
            iconSize: [25, 41], // размер иконки
            iconAnchor: [12, 41], // точка привязки иконки (координата ее "хвоста")
            popupAnchor: [1, -34], // точка, относительно которой будет открываться popup
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        // Функция для извлечения координат начала и конца из KML-слоя
        function getStartEndCoordinates(layer) {
            var coordinates;
            layer.eachLayer(function (l) {
                if (l.feature.geometry.type === 'LineString') {
                    coordinates = l.feature.geometry.coordinates;
                } else if (l.feature.geometry.type === 'MultiLineString') {
                    coordinates = l.feature.geometry.coordinates[0];
                }
            });

            var start = coordinates[0];
            var end = coordinates[coordinates.length - 1];
            return {
                start: [start[1], start[0]], // Переставляем координаты для Leaflet
                end: [end[1], end[0]] // Переставляем координаты для Leaflet
            };
        }

        // Функция для загрузки и отображения KML-файлов на сервер
        function uploadKmlFiles(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('kmlFiles', files[i]);
            }
            fetch('/uploadKML', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                console.log(data);
                loadKmlFilesFromServer();
            })
            .catch(error => console.error('Error uploading KML files:', error));
        }

        // Функция для загрузки и отображения KML-файлов с сервера
        function loadKmlFilesFromServer() {
            fetch('/uploads')
                .then(response => response.json())
                .then(data => {
                    data.forEach(file => {
                        var kmlLayer = omnivore.kml(file.path);
                        kmlLayer.on('ready', function() {
                            map.fitBounds(kmlLayer.getBounds());

                            // Получаем координаты начала и конца
                            var coords = getStartEndCoordinates(kmlLayer);

                            // Добавляем маркер с названием файла
                            L.marker(coords.start, {icon: startIcon}).addTo(map)
                                .setZIndexOffset(1000)
                                .bindPopup("Начало: " + file.name);

                            L.marker(coords.end, {icon: endIcon}).addTo(map)
                                .setZIndexOffset(1000)
                                .bindPopup("Конец: " + file.name);
                        }).addTo(map);
                    });
                })
                .catch(error => console.error('Error loading KML files from server:', error));
        }

        // Функция для загрузки и отображения изображений на сервер
        function uploadImageFiles(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('imageFiles', files[i]);
            }
            fetch('/uploadImages', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                console.log(data);
                loadPhotosFromServer();
            })
            .catch(error => console.error('Error uploading image files:', error));
        }

        // Функция для загрузки и отображения фотографий с сервера
        function loadPhotosFromServer() {
            fetch('/photos')
                .then(response => response.json())
                .then(data => {
                    data.forEach(photo => {
                        var lat = photo.lat;
                        var lon = photo.lon;
                        var direction = photo.direction;
                        var imgSrc = photo.src;

                        // Создаем маркер для изображения
                        var imageMarker = L.marker([lat, lon]);

                        // Создаем popup с изображением
                        var popupContent = '<img src="' + imgSrc + '" style="width: 100%; max-width: 200px; height: auto;" />';
                        imageMarker.bindPopup(popupContent).addTo(map);

                        // Если есть направление, добавляем стрелку направления
                        if (direction) {
                            L.marker([lat, lon], {
                                icon: L.divIcon({
                                    className: 'direction-arrow',
                                    html: '<div style="transform: rotate(' + direction + 'deg);">&#x2191;</div>',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                })
                            }).addTo(map).setZIndexOffset(1000);
                        }
                    });
                })
                .catch(error => console.error('Error loading photos from server:', error));
        }

        // Загрузка фотографий и KML-файлов с сервера при инициализации карты
        loadPhotosFromServer();
        loadKmlFilesFromServer();

        // Обработка события выбора KML-файлов
        document.getElementById('fileInput').addEventListener('change', function(event) {
            var files = event.target.files;
            if (files) {
                uploadKmlFiles(files);
            }
        });

        // Обработка события выбора изображений
        document.getElementById('imageInput').addEventListener('change', function(event) {
            var files = event.target.files;
            if (files) {
                uploadImageFiles(files);
            }
        });
    </script>
</body>
</html>
